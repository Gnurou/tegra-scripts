ARCH_PACKAGES="
glproto
dri2proto
dri3proto
presentproto
libxext
libxcb
libxdamage
libxfixes
libxshmfence
libxcursor
libxkbcommon-x11
libjpeg-turbo
libinput
libdrm
cairo
mtdev
wayland
xcmiscproto
xtrans
bigreqsproto
randrproto
inputproto
videoproto
compositeproto
recordproto
scrnsaverproto
resourceproto
xf86driproto
xineramaproto
xcb-util-keysyms
xorg-xinit
xorg-fonts
xorg-fonts-misc
xorg-xsetroot
terminus-font
noto-fonts
xterm
mesa-demos
"

status "Using qemu to install required packages on target FS..."
run_in_qemu pacman -Syu --needed --noconfirm $ARCH_PACKAGES

status "Fixing symlinks in target FS' /usr/lib/..."
LINKS=$(find $SYSROOT/usr/lib -type l)
for LINK in $LINKS; do
    L=$(readlink $LINK)
    if [[ "$L" = /* ]]; then
        R=$(dirname $LINK)
	ABS="${SYSROOT}${L}"
        RL=$(realpath -s --relative-to $R $ABS)
        echo Linking $LINK to $RL
        ln -sf $RL $LINK
    fi
done

status "Updating X server path in /etc/X11..."
find $SYSROOT/etc/X11 -type f -exec sed -i 's/\/usr\/bin\/X\b/\/opt\/nouveau\/bin\/X/g' {} +
